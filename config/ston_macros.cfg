# =============================================================================
# STōN-WoLF MACRO SYSTEM
# Complete macro package for STōN-WoLF printers
# 
# All user-configurable settings are in _USER_VARIABLES.cfg
# This file contains the macro logic - customers should not need to edit this!
# 
# =============================================================================



# =============================================================================
# MAINSAIL CLIENT VARIABLES
# Controls pause/resume/cancel behavior in Mainsail interface
# =============================================================================
[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos   : True         ; Use custom park positions from user variables
variable_custom_park_x    : 0            ; Set by user_variables
variable_custom_park_y    : 0            ; Set by user_variables
variable_custom_park_dz   : 0            ; Set by user_variables
variable_retract          : 0            ; Set by user_variables
variable_cancel_retract   : 0            ; Set by user_variables
variable_speed_hop        : 12.0         ; Z movement speed (mm/s)
variable_park_at_cancel   : True         ; Park toolhead when canceling
variable_park_at_cancel_x : 0            ; Set by user_variables
variable_park_at_cancel_y : 0            ; Set by user_variables
gcode:
    # Load values from user variables
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    SET_GCODE_VARIABLE MACRO=_CLIENT_VARIABLE VARIABLE=custom_park_x VALUE={user.pause_x}
    SET_GCODE_VARIABLE MACRO=_CLIENT_VARIABLE VARIABLE=custom_park_y VALUE={user.pause_y}
    SET_GCODE_VARIABLE MACRO=_CLIENT_VARIABLE VARIABLE=custom_park_dz VALUE={user.pause_dz}
    SET_GCODE_VARIABLE MACRO=_CLIENT_VARIABLE VARIABLE=retract VALUE={user.pause_retract}
    SET_GCODE_VARIABLE MACRO=_CLIENT_VARIABLE VARIABLE=cancel_retract VALUE={user.cancel_retract}
    SET_GCODE_VARIABLE MACRO=_CLIENT_VARIABLE VARIABLE=park_at_cancel_x VALUE={user.cancel_x}
    SET_GCODE_VARIABLE MACRO=_CLIENT_VARIABLE VARIABLE=park_at_cancel_y VALUE={user.cancel_y}


# =============================================================================
# PRINT START & END
# Automatic start sequence called by slicer with adaptive probing
# =============================================================================

[gcode_macro PRINT_START]
description: Start print sequence with adaptive probing
# Called by slicer with: PRINT_START BED=[bed_temp] EXTRUDER=[extruder_temp]
# Optional: MODE=NORMAL/QUIET/SPEED/CUSTOM1-5 (default: NORMAL)
# Optional: PROBE_OFFSET=XX to override default probe offset
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    {% set BED = params.BED|default(60)|float %}
    {% set EXTRUDER = params.EXTRUDER|default(200)|float %}
    {% set MODE = params.MODE|default("NORMAL")|string|upper %}
    {% set PROBE_OFFSET = params.PROBE_OFFSET|default(user.probe_offset_default)|float %}
    
    # Reset to known state
    RESPOND MSG="Resetting to {MODE} mode..."
    {% if MODE == "QUIET" %}
        MODE_QUIET
    {% elif MODE == "SPEED" %}
        MODE_SPEED
    {% elif MODE == "CUSTOM1" %}
        MODE_CUSTOM1
    {% elif MODE == "CUSTOM2" %}
        MODE_CUSTOM2
    {% elif MODE == "CUSTOM3" %}
        MODE_CUSTOM3
    {% elif MODE == "CUSTOM4" %}
        MODE_CUSTOM4
    {% elif MODE == "CUSTOM5" %}
        MODE_CUSTOM5
    {% else %}
        MODE_NORMAL
    {% endif %}
    
    # Tare is handled automatically by [smart_effector] activate_gcode
    # Filter modes and thresolds can be changed via tare signal, directly to QT Py
    
    # Calculate probe temp (extruder temp minus offset, minimum from config)
    {% set PROBE_TEMP = EXTRUDER - PROBE_OFFSET %}
    {% if PROBE_TEMP < user.probe_temp_minimum %}
        {% set PROBE_TEMP = user.probe_temp_minimum %}
    {% endif %}
    
    RESPOND MSG="Starting print - Bed: {BED}C, Extruder: {EXTRUDER}C, Probing at: {PROBE_TEMP}C"
    
    # Heat bed and extruder to probe temp
    M140 S{BED}                            ; set bed temp (no wait)
    M104 S{PROBE_TEMP}                     ; set extruder to probe temp (no wait)
    M190 S{BED}                            ; wait for bed temp
    M109 S{PROBE_TEMP}                     ; wait for probe temp
    
    # Note: Force sensor tares automatically before each probe via [smart_effector]
    G4 P100                                ; settle time
    RESPOND MSG="Taring force sensor before probing..."
    
    # Home all axes
    G28
    
    # Wipe off startup blob
    WIPE_NOZZLE
    
    # Re-home Z with clean nozzle
    G28 Z
    
    # Create adaptive bed mesh at probe temp
    RESPOND MSG="Creating adaptive bed mesh at {PROBE_TEMP}C..."
    BED_MESH_CLEAR
    G1 E-{user.start_retract_before_mesh} F1800  ; micro-retract to prevent ooze contamination
    BED_MESH_CALIBRATE ADAPTIVE=1
    
    # Heat to final print temp
    RESPOND MSG="Heating to print temp: {EXTRUDER}C..."
    M109 S{EXTRUDER}
    
    # Final wipe to remove ooze
    WIPE_NOZZLE
    
    # Purge line near print area
    _PURGE_LINE
    
    RESPOND MSG="Print starting!"


[gcode_macro PRINT_END]
description: End print sequence - parks and cools down
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    
    RESPOND MSG="Print complete - parking and cooling down..."
    
    # Lift nozzle away from print
    G91                                    ; relative positioning
    G1 E-{user.end_retract} F2700          ; retract
    G1 Z{user.end_lift} F{user.z_lift_speed}  ; lift
    
    # Park at rear center
    G90                                    ; absolute positioning
    G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y - user.end_park_offset} F{user.travel_speed}
    
    # Shutdown sequence
    TURN_OFF_HEATERS
    M107                                   ; fan off
    
    # Wait for moves to finish before disabling motors (prevents gantry sag)
    M400                                   ; wait for buffer to clear
    G4 P200                                ; dwell 500ms
    M84                                    ; motors off
    
    RESPOND MSG="Print finished"

# =============================================================================
# PREHEAT WITH AUTO-SHUTOFF
# Preheat bed and extruder with timeout timer for safety
# =============================================================================

[gcode_macro PREHEAT]
description: Preheat with auto-shutoff - PREHEAT BED=80 EXTRUDER=160 DURATION=60
# Usage: PREHEAT BED=80 EXTRUDER=160 DURATION=60
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    {% set BED_TEMP = params.BED|default(user.preheat_bed_default)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(user.preheat_extruder_default)|float %}
    {% set DURATION = params.DURATION|default(user.preheat_duration_default)|int %}
    
    # Safety limits
    {% if BED_TEMP < 40 %}
        {% set BED_TEMP = 40 %}
        RESPOND MSG="Bed temp too low, set to 40C minimum"
    {% elif BED_TEMP > 115 %}
        {% set BED_TEMP = 115 %}
        RESPOND MSG="Bed temp capped at 115C for magnets"
    {% endif %}
    
    {% if EXTRUDER_TEMP < 140 %}
        {% set EXTRUDER_TEMP = 140 %}
        RESPOND MSG="Extruder temp too low, set to 140C minimum"
    {% elif EXTRUDER_TEMP > 290 %}
        {% set EXTRUDER_TEMP = 290 %}
        RESPOND MSG="Extruder temp too high, set to 290C maximum"
    {% endif %}
    
    {% if DURATION < 30 %}
        {% set DURATION = 30 %}
        RESPOND MSG="Duration too short, set to 30 minutes minimum"
    {% elif DURATION > 120 %}
        {% set DURATION = 120 %}
        RESPOND MSG="Duration too long, set to 120 minutes maximum"
    {% endif %}
    
    RESPOND MSG="Starting preheat - Bed: {BED_TEMP}C, Extruder: {EXTRUDER_TEMP}C for {DURATION} minutes"
    
    # Start heating (no wait)
    M140 S{BED_TEMP}
    M104 S{EXTRUDER_TEMP}
    
    # Home and park
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    PARKFRONT
    
    # Turn off motors, turn on fan for circulation
    M84
    M106 S{user.preheat_fan_speed}       ; Fan for air circulation
    
    # Start timer
    SET_GCODE_VARIABLE MACRO=_MACRO_STATE VARIABLE=preheat_target_bed VALUE={BED_TEMP}
    SET_GCODE_VARIABLE MACRO=_MACRO_STATE VARIABLE=preheat_target_extruder VALUE={EXTRUDER_TEMP}
    SET_GCODE_VARIABLE MACRO=_MACRO_STATE VARIABLE=preheat_time_remaining VALUE={DURATION * 60}
    UPDATE_DELAYED_GCODE ID=preheat_timer DURATION={user.preheat_check_interval}


[gcode_macro CANCEL_PREHEAT]
description: Cancel preheat timer and turn off all heaters
gcode:
    RESPOND MSG="Canceling preheat..."
    
    # Stop timer
    SET_GCODE_VARIABLE MACRO=_MACRO_STATE VARIABLE=preheat_time_remaining VALUE=0
    UPDATE_DELAYED_GCODE ID=preheat_timer DURATION=0
    
    # Turn off heaters
    TURN_OFF_HEATERS
    M107
    
    # Verify shutdown
    {% set bed_target = printer.heater_bed.target %}
    {% set extruder_target = printer.extruder.target %}
    
    {% if bed_target > 0 or extruder_target > 0 %}
        RESPOND TYPE=error MSG="WARNING: Heaters may still be on! Bed: {bed_target}C, Extruder: {extruder_target}C"
    {% else %}
        RESPOND MSG="Preheat canceled - all heaters confirmed OFF"
    {% endif %}


[delayed_gcode preheat_timer]
# Internal timer - runs every 10 seconds during preheat
gcode:
    {% set state = printer['gcode_macro _MACRO_STATE'] %}
    {% set time_remaining = state.preheat_time_remaining - state.preheat_check_interval %}
    
    {% if time_remaining <= 0 %}
        # Timer expired - shutdown
        RESPOND MSG="Preheat complete - turning off heaters"
        TURN_OFF_HEATERS
        M107
        SET_GCODE_VARIABLE MACRO=_MACRO_STATE VARIABLE=preheat_time_remaining VALUE=0
        
        # Safety check
        {% set bed_target = printer.heater_bed.target %}
        {% set extruder_target = printer.extruder.target %}
        {% if bed_target > 0 or extruder_target > 0 %}
            RESPOND TYPE=error MSG="CRITICAL: Heaters still on after timeout! Forcing off..."
            TURN_OFF_HEATERS
        {% else %}
            RESPOND MSG="All heaters confirmed OFF"
        {% endif %}
        
    {% else %}
        # Continue timer
        SET_GCODE_VARIABLE MACRO=_MACRO_STATE VARIABLE=preheat_time_remaining VALUE={time_remaining}
        
        # Status report every 5 minutes
        {% if time_remaining % 300 < state.preheat_check_interval %}
            {% set bed_actual = printer.heater_bed.temperature %}
            {% set extruder_actual = printer.extruder.temperature %}
            RESPOND MSG="Preheat: {(time_remaining / 60)|int} min remaining - Bed: {bed_actual}C, Extruder: {extruder_actual}C"
        {% endif %}
        
        # Safety: Check if heaters were turned off externally
        {% set bed_target = printer.heater_bed.target %}
        {% set extruder_target = printer.extruder.target %}
        {% if bed_target == 0 and extruder_target == 0 %}
            RESPOND MSG="Heaters turned off externally - stopping preheat timer"
            SET_GCODE_VARIABLE MACRO=_MACRO_STATE VARIABLE=preheat_time_remaining VALUE=0
        {% else %}
            UPDATE_DELAYED_GCODE ID=preheat_timer DURATION={state.preheat_check_interval}
            G4 P1
        {% endif %}
    {% endif %}


# =============================================================================
# NOZZLE CLEANING & PURGING
# =============================================================================

[gcode_macro WIPE_NOZZLE]
description: Wipe nozzle on brush (auto-homes if needed, lifts to Z=50 when done)
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    
    {% if not user.wiper_installed %}
        RESPOND MSG="Wiper not installed - skipping wipe"
    {% else %}
        # Auto-home if not homed
        {% if "xyz" not in printer.toolhead.homed_axes %}
            RESPOND MSG="Homing printer..."
            G28
        {% endif %}
        
        RESPOND MSG="Wiping nozzle..."
        
        G90
        
        # Move to wiper
        G1 X{user.wipe_x} Y{user.wipe_y} Z{user.wipe_z + 5} F{user.travel_speed}
        G1 Z{user.wipe_z} F{user.z_hop_speed}
        
        # Progressive speed wipes (accelerating passes)
        G1 X{user.wipe_x - user.wipe_dist/2} F{user.wipe_speed_1}   ; 20mm/s default
        G1 X{user.wipe_x + user.wipe_dist/2} F{user.wipe_speed_2}   ; 40mm/s default
        G1 X{user.wipe_x - user.wipe_dist/2} F{user.wipe_speed_3}   ; 80mm/s default
        G1 X{user.wipe_x + user.wipe_dist/2} F{user.wipe_speed_4}   ; 160mm/s default
        G1 X{user.wipe_x - user.wipe_dist/2} F{user.wipe_speed_5}   ; 320mm/s default
        
        # Lift to safe height and stay there
        G1 Z50 F{user.z_hop_speed}
        
        RESPOND MSG="Nozzle wiped"
    {% endif %}


[gcode_macro _PURGE_LINE]
description: Two-pass purge line near print start position (called by PRINT_START)
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    
    RESPOND MSG="Purging nozzle..."
    
    SAVE_GCODE_STATE NAME=purge_state
    G90
    
    # Move to purge start
    G1 X{user.purge_x_start} Y{user.purge_y} Z{user.purge_z} F{user.travel_speed}
    G1 Z{user.purge_z} F{user.z_hop_speed}
    
    # Safety check - abort if Z is dangerously low (bad Z offset or mesh)
    {% if printer.toolhead.position.z < user.purge_z_min_safe %}
        RESPOND TYPE=error MSG="PURGE ABORTED: Z={printer.toolhead.position.z}mm is too low! Check Z offset and bed mesh."
        RESTORE_GCODE_STATE NAME=purge_state
        CANCEL_PRINT
    {% endif %}
    
    # Pass 1: Normal purge
    G91
    G1 X{user.purge_length} E{user.purge_extrude_1} F{user.purge_speed}
    
    # Pass 2: Fat blob (offset 0.4mm)
    G1 Y0.4 F{user.travel_speed}
    G1 X-{user.purge_length} E{user.purge_extrude_2} F{user.purge_speed}
    
    # Lift and continue
    G1 Z5 F{user.z_hop_speed}
    RESTORE_GCODE_STATE NAME=purge_state
    
    RESPOND MSG="Purge complete"


[gcode_macro PURGE_NOZZLE]
description: Purge filament slowly - PURGE_NOZZLE TEMP=200 (or leave empty if already hot)
# Usage: PURGE_NOZZLE TEMP=200 (or leave empty to use current temp)
gcode:
    {% set TEMP = params.TEMP|default(0)|float %}
    
    # If temp specified, start heating (no wait - user can cancel)
    {% if TEMP > 0 %}
        {% if TEMP < 180 %}
            RESPOND MSG="Temp too low, minimum 180C"
            {% set TEMP = 180 %}
        {% elif TEMP > 350 %}
            RESPOND MSG="Temp too high, maximum 350C"
            {% set TEMP = 350 %}
        {% endif %}
        
        RESPOND MSG="Heating to {TEMP}C... (cancel anytime by setting temp to 0)"
        M104 S{TEMP}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={TEMP}
    {% else %}
        # Check if already hot enough
        {% if printer.extruder.temperature < 180 %}
            RESPOND TYPE=error MSG="Extruder too cold! Specify TEMP=xxx or heat manually first."
            {action_raise_error("Extruder not hot enough for purging")}
        {% endif %}
    {% endif %}
    
    RESPOND MSG="Purging 30mm at 5mm/s..."
    
    G92 E0                          ; Reset extruder position
    M83                             ; Relative extrusion
    G1 E30 F300                     ; Purge 30mm at 5mm/s (300mm/min)
    G92 E0                          ; Reset extruder position
    
    M18 E                           ; Disable extruder motor
    
    RESPOND MSG="Purge complete - extruder motor disabled"


# =============================================================================
# FILAMENT HANDLING
# =============================================================================

[gcode_macro LOAD_FILAMENT]
description: Load filament (heat extruder first!)
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    
    G92 E0
    M83                                    ; Relative extrusion
    G1 E{user.load_prime_length} F{user.load_prime_speed}      ; Slow prime
    G1 E{user.load_fast_length} F{user.load_fast_speed}        ; Fast load
    G1 E{user.load_medium_length} F{user.load_medium_speed}    ; Medium load
    G1 E{user.load_final_length} F{user.load_final_speed}      ; Final slow load
    G92 E0


[gcode_macro UNLOAD_FILAMENT]
description: Unload filament (heat extruder first!)
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    
    G92 E0
    M83                                    ; Relative extrusion
    G1 E{user.unload_purge_length} F{user.unload_purge_speed}      ; Purge
    G1 E-{user.unload_fast_length} F{user.unload_fast_speed}       ; Fast retract
    G1 E-{user.unload_slow_length} F{user.unload_slow_speed}       ; Slow retract (cold zone)
    G1 E-{user.unload_final_length} F{user.unload_final_speed}     ; Final fast retract
    G92 E0


[gcode_macro M600]
description: Pause for filament change - Parks toolhead and waits for you to swap filament
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    PAUSE X={user.pause_x} Y={user.pause_y} Z_MIN={user.m600_z_min}
    RESPOND MSG="Filament change - swap filament and click RESUME when ready"


# =============================================================================
# PARKING & POSITIONING
# =============================================================================

[gcode_macro PARKFRONT]
description: Park toolhead at front - Safe position for maintenance or filament changes
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    SAVE_GCODE_STATE NAME=PARKFRONT
    G90
    
    # Use user-defined positions or auto-calculate
    {% set park_x = user.park_x if user.park_x > 0 else printer.toolhead.axis_maximum.x/2 %}
    {% set park_y = user.park_y if user.park_y > 0 else printer.toolhead.axis_minimum.y+5 %}
    {% set park_z = printer.toolhead.axis_maximum.z/2 %}
    
    G0 X{park_x} Y{park_y} Z{park_z} F{user.homing_travel_speed}
    RESTORE_GCODE_STATE NAME=PARKFRONT


[gcode_macro PARKFRONTLOW]
description: Park toolhead at front low - Easy access for nozzle work or bed removal
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    SAVE_GCODE_STATE NAME=PARKFRONT
    G90
    
    # Use user-defined positions or auto-calculate
    {% set park_x = user.park_x if user.park_x > 0 else printer.toolhead.axis_maximum.x/2 %}
    {% set park_y = user.park_y if user.park_y > 0 else printer.toolhead.axis_minimum.y+5 %}
    
    G0 X{park_x} Y{park_y} Z{user.parklow_z} F{user.homing_travel_speed}
    RESTORE_GCODE_STATE NAME=PARKFRONT


[gcode_macro OFF]
description: Turn off motors, heaters, and fans when printer is idle
gcode:
    M84                                    ; Motors off
    TURN_OFF_HEATERS                       ; Heaters off
    M107                                   ; Fan off


# =============================================================================
# PERFORMANCE MODES
# =============================================================================
# 
# STōN-WoLF Performance Modes
# QUIET - The prowl (60% speed, quiet overnight)
# NORMAL - The hunt (100% speed, 70% fan)
# SPEED - The chase (150% speed, max performance)
# CUSTOM1-5 - Your pack, your rules (configure in _USER_VARIABLES.cfg)
#
# =============================================================================

[gcode_macro MODE_QUIET]
description: Quiet mode - 50% speed, 40% fan
gcode:
    M220 S50
    SET_VELOCITY_LIMIT VELOCITY=800 ACCEL=15000 SQUARE_CORNER_VELOCITY=9
    M204 S15000
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=fan_limit VALUE=0.4
    RESPOND MSG="Mode: QUIET - 50% speed, 40% fan"


[gcode_macro MODE_NORMAL]
description: Standard printing - 100% speed, 70% fan
gcode:
    M220 S100
    SET_VELOCITY_LIMIT VELOCITY=1400 ACCEL=25000 SQUARE_CORNER_VELOCITY=10
    M204 S25000
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=fan_limit VALUE=0.7
    RESPOND MSG="Mode: NORMAL - 100% speed, 70% fan"


[gcode_macro MODE_SPEED]
description: Speed mode - 150% speed, 100% fan
gcode:
    M220 S150
    SET_VELOCITY_LIMIT VELOCITY=1500 ACCEL=25000 SQUARE_CORNER_VELOCITY=12
    M204 S25000
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=fan_limit VALUE=1.0
    RESPOND MSG="Mode: SPEED - 150% speed, 100% fan"


[gcode_macro MODE_CUSTOM1]
description: Custom slot 1 - Configure in _USER_VARIABLES.cfg
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    M220 S{vars.custom1_speed}
    SET_VELOCITY_LIMIT VELOCITY={vars.custom1_velocity} ACCEL={vars.custom1_accel} SQUARE_CORNER_VELOCITY={vars.custom1_scv}
    M204 S{vars.custom1_accel}
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=fan_limit VALUE={vars.custom1_fan}
    RESPOND MSG="Mode: {vars.custom1_name} - {vars.custom1_speed}% speed, {vars.custom1_accel} accel"

[gcode_macro MODE_CUSTOM2]
description: Custom slot 2 - Configure in _USER_VARIABLES.cfg
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    M220 S{vars.custom2_speed}
    SET_VELOCITY_LIMIT VELOCITY={vars.custom2_velocity} ACCEL={vars.custom2_accel} SQUARE_CORNER_VELOCITY={vars.custom2_scv}
    M204 S{vars.custom2_accel}
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=fan_limit VALUE={vars.custom2_fan}
    RESPOND MSG="Mode: {vars.custom2_name} - {vars.custom2_speed}% speed, {vars.custom2_accel} accel"

[gcode_macro MODE_CUSTOM3]
description: Custom slot 3 - Configure in _USER_VARIABLES.cfg
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    M220 S{vars.custom3_speed}
    SET_VELOCITY_LIMIT VELOCITY={vars.custom3_velocity} ACCEL={vars.custom3_accel} SQUARE_CORNER_VELOCITY={vars.custom3_scv}
    M204 S{vars.custom3_accel}
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=fan_limit VALUE={vars.custom3_fan}
    RESPOND MSG="Mode: {vars.custom3_name} - {vars.custom3_speed}% speed, {vars.custom3_accel} accel"

[gcode_macro MODE_CUSTOM4]
description: Custom slot 4 - Configure in _USER_VARIABLES.cfg
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    M220 S{vars.custom4_speed}
    SET_VELOCITY_LIMIT VELOCITY={vars.custom4_velocity} ACCEL={vars.custom4_accel} SQUARE_CORNER_VELOCITY={vars.custom4_scv}
    M204 S{vars.custom4_accel}
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=fan_limit VALUE={vars.custom4_fan}
    RESPOND MSG="Mode: {vars.custom4_name} - {vars.custom4_speed}% speed, {vars.custom4_accel} accel"

[gcode_macro MODE_CUSTOM5]
description: Custom slot 5 - Configure in _USER_VARIABLES.cfg
gcode:
    {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
    M220 S{vars.custom5_speed}
    SET_VELOCITY_LIMIT VELOCITY={vars.custom5_velocity} ACCEL={vars.custom5_accel} SQUARE_CORNER_VELOCITY={vars.custom5_scv}
    M204 S{vars.custom5_accel}
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=fan_limit VALUE={vars.custom5_fan}
    RESPOND MSG="Mode: {vars.custom5_name} - {vars.custom5_speed}% speed, {vars.custom5_accel} accel"


# =============================================================================
# FAN LIMITING OVERRIDE
# Applies mode-based fan speed limiting
# =============================================================================
[gcode_macro M106]
variable_fan_limit: 1.0
rename_existing: M106.1
description: Overrides M106 to apply mode-based fan limiting
gcode:
    {% if params.S is defined %}
        {% set requested = params.S|float / 255.0 %}
        {% set limited = (requested * fan_limit) %}
        {% set speed = (limited * 255.0)|int %}
        M106.1 S{speed}
    {% else %}
        M106.1 {rawparams}
    {% endif %}


[gcode_macro FAN_LIMIT]
description: Adjust fan speed limit - Range 0-100 (0=reset to current mode)
gcode:
    {% set LIMIT = params.LIMIT|default(-1)|int %}
    
    # Show help if no parameter
    {% if LIMIT < 0 %}
        {% set current_limit = printer["gcode_macro M106"].fan_limit %}
        RESPOND MSG="═══════════════════════════════════════════"
        RESPOND MSG="FAN LIMIT SCALER"
        RESPOND MSG=" "
        RESPOND MSG="Current scaler: {(current_limit * 100)|int}%"
        RESPOND MSG=" "
        RESPOND MSG="Adjusts ALL fan speeds by this multiplier."
        RESPOND MSG="Persists through gcode M106 commands."
        RESPOND MSG=" "
        RESPOND MSG="Usage: FAN_LIMIT LIMIT=90"
        RESPOND MSG=" "
        RESPOND MSG="Examples:"
        RESPOND MSG="  0   = Reset to current mode default"
        RESPOND MSG="  40  = Scale all fan to 40%"
        RESPOND MSG="  70  = Scale all fan to 70%"
        RESPOND MSG="  90  = Scale all fan to 90%"
        RESPOND MSG="  100 = No scaling (100%)"
        RESPOND MSG=" "
        RESPOND MSG="Note: Hardware max_power still applies"
        RESPOND MSG="═══════════════════════════════════════════"
    
    # Reset to mode default
    {% elif LIMIT == 0 %}
        {% set current_speed = printer.gcode_move.speed_factor %}
        {% if current_speed <= 0.55 %}
            MODE_QUIET
            RESPOND MSG="Fan limit reset to QUIET mode (40%)"
        {% elif current_speed >= 1.4 %}
            MODE_SPEED
            RESPOND MSG="Fan limit reset to SPEED mode (100%)"
        {% else %}
            MODE_NORMAL
            RESPOND MSG="Fan limit reset to NORMAL mode (70%)"
        {% endif %}
    
    # Set custom limit
    {% else %}
        # Cap at 100 max
        {% if LIMIT > 100 %}
            {% set LIMIT = 100 %}
            RESPOND MSG="Fan limit capped at 100%"
        {% elif LIMIT < 0 %}
            {% set LIMIT = 0 %}
        {% endif %}
        
        # Convert percentage to decimal for internal use
        {% set LIMIT_DECIMAL = LIMIT / 100.0 %}
        SET_GCODE_VARIABLE MACRO=M106 VARIABLE=fan_limit VALUE={LIMIT_DECIMAL}
        RESPOND MSG="Fan scaler set to {LIMIT}% - All M106 commands scaled"
    {% endif %}


# =============================================================================
# ACCEL SAFETY OVERRIDE
# Enforces speed-dependent acceleration limits for safety
# =============================================================================
[gcode_macro M204]
rename_existing: M204.1
description: Overrides M204 to enforce speed-dependent accel limits
gcode:
    {% set current_velocity = printer.toolhead.max_velocity|float %}
    
    # Speed-dependent accel caps
    {% if current_velocity > 1000 %}
        {% set ACCEL_CEILING = 25000 %}
    {% else %}
        {% set ACCEL_CEILING = 50000 %}
    {% endif %}
    
    {% if params.S is defined %}
        {% set requested_accel = params.S|float %}
        {% set safe_accel = [requested_accel, ACCEL_CEILING]|min %}
        M204.1 S{safe_accel}
        {% if requested_accel > safe_accel %}
            RESPOND MSG="Accel limited to {safe_accel} for safety at {current_velocity}mm/s"
        {% endif %}
    {% else %}
        M204.1 {rawparams}
    {% endif %}


# =============================================================================
# TEMPERATURE OVERRIDES
# Tighter tolerance and safety caps
# =============================================================================

[gcode_macro M104]
description: Set extruder temp with 350C cap
rename_existing: M99104
gcode:
    {% set s = params.S|default(0)|float %}
    
    # Cap at 350C for safety
    {% if s > 350 %}
        {% set s = 350 %}
        RESPOND MSG="Extruder temp capped at 350C maximum"
    {% endif %}
    
    # Call original M104 command with capped temp
    M99104 S{s}


[gcode_macro M140]
description: Set bed temp with 115C cap (magnet protection)
rename_existing: M99140
gcode:
    {% set s = params.S|default(0)|float %}
    
    # Cap at 115C for magnets
    {% if s > 115 %}
        {% set s = 115 %}
        RESPOND MSG="Bed temp capped at 115C for magnets"
    {% endif %}
    
    # Call original M140 command with capped temp
    M99140 S{s}


[gcode_macro M109]
description: Wait for extruder temp with tighter tolerance and 350C cap
rename_existing: M99109
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    {% set s = params.S|float %}
    
    # Cap at 350C for safety
    {% if s > 350 %}
        {% set s = 350 %}
        RESPOND MSG="Extruder temp capped at 350C maximum"
    {% endif %}
    
    # Call original M109 command with capped temp
    M99109 S{s}
    
    # Tighten tolerance to ±1°C if enabled
    {% if user.use_tight_temp_control and s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s} MAXIMUM={s+1}
    {% endif %}


[gcode_macro M190]
description: Wait for bed temp with tighter tolerance and 115C cap (magnet protection)
rename_existing: M99190
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    {% set s = params.S|float %}
    
    # Cap at 115C for magnets
    {% if s > 115 %}
        {% set s = 115 %}
        RESPOND MSG="Bed temp capped at 115C for magnets"
    {% endif %}
    
    # Call original M190 command with capped temp
    M99190 S{s}
    
    # Tighten tolerance to ±1°C if enabled
    {% if user.use_tight_temp_control and s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s} MAXIMUM={s+1}
    {% endif %}


[gcode_macro SET_HEATER_TEMPERATURE]
description: Intercept Mainsail/Fluidd temp commands with limits
rename_existing: _SET_HEATER_TEMPERATURE
gcode:
    {% set HEATER = params.HEATER|default("extruder")|string %}
    {% set TARGET = params.TARGET|default(0)|float %}
    
    # Apply limits based on heater type
    {% if HEATER == "extruder" %}
        {% if TARGET > 350 %}
            {% set TARGET = 350 %}
            RESPOND MSG="Extruder temp capped at 350C maximum"
        {% endif %}
    {% elif HEATER == "heater_bed" %}
        {% if TARGET > 120 %}
            {% set TARGET = 120 %}
            RESPOND MSG="Bed temp capped at 120C maximum"
        {% endif %}
    {% endif %}
    
    # Call original command with capped temp
    _SET_HEATER_TEMPERATURE HEATER={HEATER} TARGET={TARGET}


# =============================================================================
# PROBE TARE & CONFIGURATION
# =============================================================================

# -----------------------------------------------------------------------------
# LOW-LEVEL PULSE (INTERNAL USE ONLY)
# -----------------------------------------------------------------------------
[gcode_macro _SEND_PULSE]
gcode:
    {% set p = params.P|int %}
    M400
    SET_PIN PIN=_TARE_pin VALUE=0
    G4 P{p}
    SET_PIN PIN=_TARE_pin VALUE=1

# -----------------------------------------------------------------------------
# ATOMIC CONFIG COMMIT (FILTER + THRESHOLD)
# -----------------------------------------------------------------------------
[gcode_macro _COMMIT_PROBE_CONFIG]
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    # ---- Pulse 1 (filter) ----
    SET_PIN PIN=_TARE_pin VALUE=0
    G4 P{user.filter_pulse_ms}
    SET_PIN PIN=_TARE_pin VALUE=1
    # ---- REQUIRED inter-pulse HIGH dwell ----
    G4 P100
    # ---- Pulse 2 (threshold) ----
    SET_PIN PIN=_TARE_pin VALUE=0
    G4 P{user.threshold_pulse_ms}
    SET_PIN PIN=_TARE_pin VALUE=1

# -----------------------------------------------------------------------------
# SIMPLE TARE (USED DURING PROBING)
# -----------------------------------------------------------------------------
[gcode_macro _TARE_PROBE]
description: Tare only (no config)
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    G4 P{user.probe_settle_time}
    _SEND_PULSE P={user.tare_pulse_ms}
    G4 P{user.probe_tare_wait}


[gcode_macro SET_PROBE]
description: Set probe filter (1-5) and/or threshold (0.75-2.0)
gcode:
    {% set user = printer["gcode_macro _USER_VARIABLES"] %}
    
    {% if params.F is defined %}
        {% set level = params.F|int %}
        {% set pulse = {1:130, 2:150, 3:170, 4:190, 5:210}[level]|default(150) %}
        {% set configs = {1:[3,0], 2:[3,3], 3:[5,5], 4:[7,7], 5:[9,9]} %}
        {% set m = configs[level][0] %}
        {% set s = configs[level][1] %}
        SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=filter_pulse_ms VALUE={pulse}
        RESPOND PREFIX=" " MSG="SET_PROBE F={level}; Filter level (1-5)"
    {% endif %}
    
    {% if params.T is defined %}
        {% set scale = params.T|float %}
        {% set scale_clamped = [[scale, 0.75]|max, 2.0]|min %}
        {% set pulse = (((scale_clamped - 0.75) / 1.25) * 300 + 100)|int %}
        SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=threshold_pulse_ms VALUE={pulse}
        RESPOND PREFIX=" " MSG="SET_PROBE T={scale_clamped};  Threshold scale (0.75 to 2.0)"
    {% endif %}
    
    {% if params.F is defined or params.T is defined %}
        _COMMIT_PROBE_CONFIG
    {% else %}
        RESPOND PREFIX="TARE" MSG="Current: F={user.filter_pulse_ms}ms T={user.threshold_pulse_ms}ms"
    {% endif %}


# =================================================================================
# FILTER PRESETS (UI BUTTONS) MEDIAN and SAVGOL filter levels (M/S) Default = M3/S3
# =================================================================================

[gcode_macro FILTER_1]
description: Minimal filtering (fast/sensitive) Filter type = M3/S0 
gcode:
    SET_PROBE F=1

[gcode_macro FILTER_2]
description: Light filtering(DEFAULT) Filter type = M3/S3
gcode:
    SET_PROBE F=2

[gcode_macro FILTER_3]
description: Medium filtering Filter type = M5/S5
gcode:
    SET_PROBE F=3

[gcode_macro FILTER_4]
description: High filtering Filter type = M7/S7 
gcode:
    SET_PROBE F=4

[gcode_macro FILTER_5]
description: MAX filtering (slow/stable) Filter type = M9/S9
gcode:
    SET_PROBE F=5


# =============================================================================
# THRESHOLD SCALE PRESETS (UI BUTTONS)
# =============================================================================

[gcode_macro THRESHOLD_075]
description: Threshold scale 0.75 (very sensitive)
gcode:
    SET_PROBE T=0.75

[gcode_macro THRESHOLD_100]
description: Threshold scale 1.0 (DEFAULT)
gcode:
    SET_PROBE T=1.0

[gcode_macro THRESHOLD_150]
description: Threshold scale 1.5 (tolerant)
gcode:
    SET_PROBE T=1.5

[gcode_macro THRESHOLD_200]
description: Threshold scale 2.0 (harsh environment)
gcode:
    SET_PROBE T=2.0


# =============================================================================
# CALIBRATION & MAINTENANCE
# =============================================================================

[gcode_macro PID_EXTRUDER]
description: Tune hotend PID - PID_EXTRUDER TEMP=225 FAN=50 (max 350°C)
# Usage: PID_EXTRUDER TEMP=225 FAN=50
gcode:
    {% set TEMP = params.TEMP|default(225)|float %}
    {% set FAN = params.FAN|default(50)|float %}
    
    # Validate ranges
    {% if TEMP < 180 %}
        {% set TEMP = 180 %}
        RESPOND MSG="Temp too low, set to 180C minimum"
    {% elif TEMP > 350 %}
        {% set TEMP = 350 %}
        RESPOND MSG="Temp too high, set to 350C maximum"
    {% endif %}
    
    {% if FAN < 0 %}
        {% set FAN = 0 %}
    {% elif FAN > 100 %}
        {% set FAN = 100 %}
    {% endif %}
    
    RESPOND MSG="PID tuning extruder at {TEMP}C with {FAN}% fan..."
    M106 S{(FAN / 100 * 255)|int}
    PID_CALIBRATE HEATER=extruder TARGET={TEMP}
    M106 S0
    RESPOND MSG="PID tune complete - Click SAVE_CONFIG to save results"


[gcode_macro PID_BED]
description: Tune bed PID - PID_BED TEMP=60 FAN=50 (max 115°C for magnets)
# Usage: PID_BED TEMP=60 FAN=50
gcode:
    {% set TEMP = params.TEMP|default(60)|float %}
    {% set FAN = params.FAN|default(50)|float %}
    
    # Validate ranges
    {% if TEMP < 40 %}
        {% set TEMP = 40 %}
        RESPOND MSG="Temp too low, set to 40C minimum"
    {% elif TEMP > 115 %}
        {% set TEMP = 115 %}
        RESPOND MSG="Temp capped at 115C for magnets"
    {% endif %}
    
    {% if FAN < 0 %}
        {% set FAN = 0 %}
    {% elif FAN > 100 %}
        {% set FAN = 100 %}
    {% endif %}
    
    RESPOND MSG="PID tuning bed at {TEMP}C with {FAN}% fan..."
    M106 S{(FAN / 100 * 255)|int}
    PID_CALIBRATE HEATER=heater_bed TARGET={TEMP}
    M106 S0
    RESPOND MSG="PID tune complete - Click SAVE_CONFIG to save results"


[gcode_macro LEVEL_Z]
description: Mechanically level Z motors - Grinds endstops at Z=300 (requires force_move enabled)
# WARNING: Requires [force_move] enabled in printer.cfg
gcode:
    RESPOND MSG="Starting mechanical Z leveling..."
    
    G28                                    ; Home all
    
    RESPOND MSG="Raising to 285mm..."
    G90
    G1 Z285 F600
    G4 P1000
    
    # Trick: Tell Klipper we're at 270mm (we're actually at 285mm)
    SET_KINEMATIC_POSITION Z=270
    RESPOND MSG="Position set to 270mm (actual: 285mm)"
    
    # Raise "15mm" more - actually grinding into endstops at 300mm
    RESPOND MSG="Grinding into endstops..."
    G91
    G1 Z15 F600
    G4 P1000
    
    # Release pressure
    RESPOND MSG="Releasing endstop pressure..."
    G1 Z-15 F600
    G4 P200
    
    # Re-home with leveled motors
    RESPOND MSG="Re-homing all axes..."
    G28
    
    # Park at front for inspection
    PARKFRONT
    
    RESPOND MSG="Mechanical Z leveling complete - check with paper test"


[gcode_macro PROBE_TEST]
description: Test probe accuracy - 10 samples at bed center (range should be <0.02mm)
gcode:
    RESPOND MSG="Starting probe accuracy test..."
    
    G28                                    ; Home all
    
    # Move to center of bed
    G90
    G1 X150 Y250 Z10 F12000
    
    # Run Klipper's built-in probe accuracy test (10 samples)
    RESPOND MSG="Running 10 probe samples at X150 Y250..."
    PROBE_ACCURACY
    
    RESPOND MSG="Test complete - check console for results (range should be <0.02mm)"


[gcode_macro BED_MESH_CAL]
description: Quick shortcut for BED_MESH_CALIBRATE
gcode:
    BED_MESH_CALIBRATE


[gcode_macro BED_MESH_CALIBRATE]
rename_existing: BED_MESH_CALIBRATE_BASE
description: Create bed mesh - Auto-homes first, supports ADAPTIVE=1 for print area only
gcode:
    # Auto-home if not homed
    {% if "xyz" not in printer.toolhead.homed_axes %}
        RESPOND MSG="Homing printer before bed mesh..."
        G28
    {% endif %}
    
    # Call original bed mesh calibrate with all parameters
    BED_MESH_CALIBRATE_BASE {rawparams}


# =============================================================================
# INPUT SHAPER UTILITIES
# =============================================================================

[gcode_macro SET_SHAPER_X]
description: Set X-axis INPUT SHAPER
# FREQ: 10-200 Hz (typical: 40-80 Hz)
# TYPE: zv (fastest), mzv (balanced), zvd, ei (smooth), 2hump_ei, 3hump_ei (smoothest)
# DAMPING: 0.01-1.0 (typical: 0.05)
gcode:
    {% set FREQ = params.FREQ|default(printer.configfile.settings.input_shaper.shaper_freq_x)|float %}
    {% set TYPE = params.TYPE|default(printer.configfile.settings.input_shaper.shaper_type_x)|string %}
    {% set DAMPING = params.DAMPING|default(printer.configfile.settings.input_shaper.damping_ratio_x|default(0.1))|float %}
    
    # Show hints if no params provided
    {% if params|length == 0 %}
        RESPOND MSG="═══════════════════════════════════════════"
        RESPOND MSG="X-AXIS INPUT SHAPER SETTINGS"
        RESPOND MSG=" "
        RESPOND MSG="Current: {printer.configfile.settings.input_shaper.shaper_freq_x} Hz, {printer.configfile.settings.input_shaper.shaper_type_x}"
        RESPOND MSG=" "
        RESPOND MSG="Usage: SET_SHAPER_X FREQ= TYPE=mzv DAMPING="
        RESPOND MSG=" "
        RESPOND MSG="FREQ: 10-200 Hz (typical 40-80)"
        RESPOND MSG="TYPE Options:"
        RESPOND MSG="  zv        - Fastest, least smoothing"
        RESPOND MSG="  mzv       - Balanced (most common)"
        RESPOND MSG="  zvd       - More smoothing"
        RESPOND MSG="  ei        - Good for wide resonance"
        RESPOND MSG="  2hump_ei  - Very tolerant"
        RESPOND MSG="  3hump_ei  - Most smoothing"
        RESPOND MSG="DAMPING: 0.01-1.0 (default 0.5)"
        RESPOND MSG="═══════════════════════════════════════════"
    {% else %}
        # Validate frequency range
        {% if FREQ < 10 %}
            {% set FREQ = 10 %}
            RESPOND MSG="Frequency too low, set to 10 Hz minimum"
        {% elif FREQ > 200 %}
            {% set FREQ = 200 %}
            RESPOND MSG="Frequency too high, set to 200 Hz maximum"
        {% endif %}
        
        # Validate damping ratio
        {% if DAMPING < 0.01 %}
            {% set DAMPING = 0.01 %}
            RESPOND MSG="Damping too low, set to 0.01 minimum"
        {% elif DAMPING > 1.0 %}
            {% set DAMPING = 1.0 %}
            RESPOND MSG="Damping too high, set to 1.0 maximum"
        {% endif %}
        
        SET_INPUT_SHAPER SHAPER_FREQ_X={FREQ} SHAPER_TYPE_X={TYPE} DAMPING_RATIO_X={DAMPING}
        RESPOND MSG="✓ X-axis: {FREQ} Hz, {TYPE}, damping {DAMPING}"
    {% endif %}


[gcode_macro SET_SHAPER_Y]
description: Set Y-axis INPUT SHAPER 
# FREQ: 10-200 Hz (typical: 60-120 Hz)
# TYPE: zv (fastest), mzv (balanced), zvd, ei (smooth), 2hump_ei, 3hump_ei (smoothest)
# DAMPING: 0.01-1.0 (typical: 0.04)
gcode:
    {% set FREQ = params.FREQ|default(printer.configfile.settings.input_shaper.shaper_freq_y)|float %}
    {% set TYPE = params.TYPE|default(printer.configfile.settings.input_shaper.shaper_type_y)|string %}
    {% set DAMPING = params.DAMPING|default(printer.configfile.settings.input_shaper.damping_ratio_y|default(0.1))|float %}
    
    # Show hints if no params provided
    {% if params|length == 0 %}
        RESPOND MSG="═══════════════════════════════════════════"
        RESPOND MSG="Y-AXIS INPUT SHAPER SETTINGS"
        RESPOND MSG=" "
        RESPOND MSG="Current: {printer.configfile.settings.input_shaper.shaper_freq_y} Hz, {printer.configfile.settings.input_shaper.shaper_type_y}"
        RESPOND MSG=" "
        RESPOND MSG="Usage: SET_SHAPER_Y FREQ= TYPE= DAMPING="
        RESPOND MSG=" "
        RESPOND MSG="FREQ: 10-200 Hz (typical 60-120)"
        RESPOND MSG="TYPE Options:"
        RESPOND MSG="  zv        - Fastest, least smoothing"
        RESPOND MSG="  mzv       - Balanced (most common)"
        RESPOND MSG="  zvd       - More smoothing"
        RESPOND MSG="  ei        - Good for wide resonance"
        RESPOND MSG="  2hump_ei  - Very tolerant"
        RESPOND MSG="  3hump_ei  - Most smoothing"
        RESPOND MSG="DAMPING: 0.01-1.0 (default 0.04)"
        RESPOND MSG="═══════════════════════════════════════════"
    {% else %}
        # Validate frequency range
        {% if FREQ < 10 %}
            {% set FREQ = 10 %}
            RESPOND MSG="Frequency too low, set to 10 Hz minimum"
        {% elif FREQ > 200 %}
            {% set FREQ = 200 %}
            RESPOND MSG="Frequency too high, set to 200 Hz maximum"
        {% endif %}
        
        # Validate damping ratio
        {% if DAMPING < 0.01 %}
            {% set DAMPING = 0.01 %}
            RESPOND MSG="Damping too low, set to 0.01 minimum"
        {% elif DAMPING > 1.0 %}
            {% set DAMPING = 1.0 %}
            RESPOND MSG="Damping too high, set to 1.0 maximum"
        {% endif %}
        
        SET_INPUT_SHAPER SHAPER_FREQ_Y={FREQ} SHAPER_TYPE_Y={TYPE} DAMPING_RATIO_Y={DAMPING}
        RESPOND MSG="✓ Y-axis: {FREQ} Hz, {TYPE}, damping {DAMPING}"
    {% endif %}


[gcode_macro TEST_SPEED]
description: Find max speed/accel limits - fINGER ON THE STOP BUTTON, READY FOR CRASH TO FIND THE LIMIT! START SLOW AND WORK UP! 
gcode:
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    {% set iterations = params.ITERATIONS|default(5)|int %}
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    {% set bound = params.BOUND|default(20)|int %}
    {% set smallpatternsize = params.SMALLPATTERNSIZE|default(20)|int %}
    
    {% set x_min = printer.toolhead.axis_minimum.x + bound %}
    {% set x_max = printer.toolhead.axis_maximum.x - bound %}
    {% set y_min = printer.toolhead.axis_minimum.y + bound %}
    {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
    {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
    
    {% set x_center_min = x_center - (smallpatternsize/2) %}
    {% set x_center_max = x_center + (smallpatternsize/2) %}
    {% set y_center_min = y_center - (smallpatternsize/2) %}
    {% set y_center_max = y_center + (smallpatternsize/2) %}

    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    
    M400
    G28
    {% if printer.configfile.settings.quad_gantry_level %}
        {% if printer.quad_gantry_level.applied == False %}
            QUAD_GANTRY_LEVEL
            G28 Z
        {% endif %}
    {% endif %}

    G90
    G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
    
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel * min_cruise_ratio}
    {% endif %}

    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

    {% for i in range(iterations) %}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}

        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
    
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio} 
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    M400
    G28
    G90
    G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
    G4 P1000 
    GET_POSITION

    RESTORE_GCODE_STATE NAME=TEST_SPEED


# =============================================================================
# NOTE: To test custom mode settings, use MODE_CUSTOM1-5 directly
# Configure values in _USER_VARIABLES.cfg, then restart and test
# =============================================================================

# =============================================================================
# INTERNAL STATE STORAGE
# Runtime variables used by macros - do not edit
# =============================================================================
[gcode_macro _MACRO_STATE]
description: Internal state storage for macro system
variable_preheat_target_bed: 0           ; Preheat bed target (managed by PREHEAT macro)
variable_preheat_target_extruder: 0      ; Preheat extruder target (managed by PREHEAT macro)
variable_preheat_time_remaining: 0       ; Preheat time remaining (managed by timer)
variable_preheat_check_interval: 10      ; Preheat timer check interval (seconds)
gcode:
    # This macro stores state only - no gcode executed
